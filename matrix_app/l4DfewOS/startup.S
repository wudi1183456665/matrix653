;/*********************************************************************************************************
;**
;**                                    中国软件开源组织
;**
;**                                   嵌入式实时操作系统
;**
;**                                       SylixOS(TM)
;**
;**                               Copyright  All Rights Reserved
;**
;**--------------文件信息--------------------------------------------------------------------------------
;**
;** 文   件   名: armCtx.S
;**
;** 创   建   人: Wang.Dongfang (王东方)
;**
;** 文件创建日期: 2018 年 03 月 05 日
;**
;** 描        述: arm 体系构架上下文切换.
;*********************************************************************************************************/

#ifndef ASSEMBLY
#define ASSEMBLY 1
#endif

#include <arch/arch_assembler.h>

    FILE_BEGIN()

;/*********************************************************************************************************
;  ARM 体系构架相关上下文函数
;*********************************************************************************************************/

    IMPORT_LABEL(l_main)
    IMPORT_LABEL(MXI_vcpuDisableInt)

    EXPORT_LABEL(_start)
    EXPORT_LABEL(getMSR)

;/*********************************************************************************************************
;  用户进程入口函数
;*********************************************************************************************************/
    .section .boot, "ax"

FUNC_DEF(_start)

;/*********************************************************************************************************
;  PowerPC关中断
;*********************************************************************************************************/

    BL      MXI_vcpuDisableInt

;/*********************************************************************************************************
;  PowerPC初始化堆栈
;*********************************************************************************************************/

    LINE_LABEL(ppcSpInit)                               ;/*是否添加label待定1013*/
    LIS     SP , HI(__stack_end)
    ORI     SP , SP , LO(__stack_end)
    SYNC
    SUBI    SP , SP , 32                                                ;/*  开辟 C 函数栈帧             */

    LIS     R4 , HI(~7)
    ORI     R4 , R4 , LO(~7)
    AND     SP , SP , R4                                                ;/*  向下 8 字节对齐             */


#if 1
;/*********************************************************************************************************
;  PowerPC清 0 BSS 段
;*********************************************************************************************************/

    LINE_LABEL(ppcBssClear)
    ADDIS   R4 , 0  , HI(__bss_start)
    ORI     R4 , R4 , LO(__bss_start)

    ADDIS   R7 , 0  , HI(__bss_end)
    ORI     R7 , R7 , LO(__bss_end)

    ADDIS   R5 , 0  , 0x0000

LINE_LABEL(cont2)              ;/*附带cont2功能未知*/
    STWX    R5 , 0 , R4

    ADDI    R4 , R4 , 4

    CMP     CR0, 0  , R4 , R7
    BLE     cont2

    SYNC
#endif

;/*********************************************************************************************************
;  PowerPC调用 l_main 函数
;*********************************************************************************************************/

    BL      l_main

    FUNC_END()


;/*********************************************************************************************************
;  PowerPc 获得 MSR寄存器的内容
;*********************************************************************************************************/

FUNC_DEF(getMSR)
    MFMSR   R3
    ISYNC
    BLR
    FUNC_END()

    FILE_END()

;/*********************************************************************************************************
;  END
;*********************************************************************************************************/


